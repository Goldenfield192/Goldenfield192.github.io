IR 1.10中加入了新的GUI API，这使得复杂GUI的实现成为可能。

你可以通过json或caml来自定义他们。这些元素都是可以通过鼠标操控的，你可以在车内打开对话框来解放鼠标。
>[!TIP]
> 我建议直接用[caml](caml.md)，这个用json写很折磨。


> 25/02/03填坑：我回来了
> 
> 前排提醒：我没有网页编写经验，可能很多地方的遣词造句过于冗余，还请谅解。


下文的坐标均基于以屏幕左上角为原点，水平向右为X轴正方向，竖直向下为Y轴正方向的平面直角坐标系。

# Caml

```caml
element:
  import : "RL"

element:
  import : "RL"
  screen_x = LEFT
  screen_y = BOTTOM
  
  element:
    ......
    
  element:
    ......
```

## 结构相关

| 字段名     | 数据类型             | 解释                                                                             | 可否缺省 |
|---------|------------------|--------------------------------------------------------------------------------|------|
| element | 代码块              | 标记着一个元素的开始，可以通过向其中添加嵌套的`element`来添加子元素。</br>不从属于任何其他`element`时它就是根元素，根元素允许有多个。 | 最好别  |
| import  | ResourceLocation | 标记导入的代码，等效于直接将对应文件的代码粘贴到`import`的位置，用于优化代码格式                                   | 是    |

子级元素会渲染在父级元素上，同层级元素从上到下依次渲染，后渲染的在先渲染的上。

element表示的是数组。

>[!TIP]
> 还记得车内GUI左上角的红色奔驰标吗？点一下就可以进入整体GUI的尺寸（Scale）和透明度（Opacity）设置。
> 
> IR内置的GUI全都实现了这个页面，如果你也需要的话你可以这么做：
> 
> 这个配置页可以通过新建根元素并添加`import : "immersiverailroading:gui/default/common/settings.caml"`来实现。不过接下来就不推荐在这个根元素里添加其他代码了，可以再弄一个。
> 
> 对于**需要**实现透明度的元素，请在对应`element`内添加`import : "immersiverailroading:gui/default/common/opacity.caml"`
> 
> 对于**需要**实现缩放的元素，请在对应`element`内添加`import : "immersiverailroading:gui/default/common/scale.caml"`
> 
> 请注意父子级关系，避免不需要缩放的元素被错误添加了缩放效果。

## 显示相关

渲染会以对应元素原点为中心，缩放也是。

### 位置控制
```caml
  element:
    screen_x = MIDDLE
    screen_y = TOP
    x = 10
    y = 10
    ......
```

| 字段名      | 数据类型 | 解释                                                              | 可否缺省        |
|----------|------|-----------------------------------------------------------------|-------------|
| screen_x | 枚举量  | 该元素水平方向**原点**偏移位置，可为`LEFT`（屏幕左边线）、`MIDDLE`（屏幕中央）或`RIGHT`（屏幕右边线） | 是，默认为`LEFT` |
| screen_y | 枚举量  | 该元素竖直方向**原点**偏移位置，可为`TOP`（屏幕上边线）、`MIDDLE`（屏幕中央）或`BOTTOM`（屏幕下边线） | 是，默认为`TOP`  |
| x        | int  | 该元素**渲染**水平方向偏移量，正值为向右移动，单位像素。                                  | 是，默认为0      |
| y        | int  | 该元素**渲染**竖直方向偏移量，正值为向下移动，单位像素。                                  | 是，默认为0      |

原点经过渲染偏移量偏移后才是图片与文字的“原点”；这里的“像素”就是图片和文字的像素。

### 图片显示
```caml
  element:
    image = "RL"
    ......
```

| 字段名   | 数据类型             | 解释                                                   | 可否缺省 |
|-------|------------------|------------------------------------------------------|------|
| image | ResourceLocation | 以当前元素原点为图片左上角渲染一张图片，图片会按Minecraft内的GUI像素单位逐像素渲染到屏幕上。 | 是    |

### 文字

```caml
  element:
    text =
      value = "stat.speed stat.units_speed"
      height = 6
      ......
```

| 字段名    | 数据类型   | 解释                        | 可否缺省 |
|--------|--------|---------------------------|------|
| text   | N/A    | 文字定义块的起点                  | 是    |
| value  | String | 显示的文字                     | 否    |
| height | int    | 文字高度（为Minecraft内的GUI像素单位） | 是    |

文字以当前元素原点为下侧中心渲染。

如果应用了透明度组件，则透明度<0.1时文字就不会渲染，反之则会渲染为完全不透明状态。

>[!TIP]
> 此处显示的文字可以按下表替换为对应值。仅会对最小单元进行替换，如对于"stat.speed stat.units_speed ppp"，会变成"\[车辆速度\] [当前速度单位] ppp"
> 如果对应量在车上不存在，则会替换为空字符串（比如非机车的最大速度，不能装液体的车的液体容量，etc.）

|             字段名             |                                                                                    	会被替换为                                                                                    |
|:---------------------------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|         state.speed         |                                                                                    车辆当前速度                                                                                    |
|       state.max_speed       |                                                                                    车辆最大速度                                                                                    |
|      state.units_speed      |                                                                          游戏当前使用的速度单位（km/h、mph或m/s）                                                                           |
|        state.liquid         |                                                                                   车辆当前液体容量                                                                                   |
|      state.max_liquid       |                                                                                   车辆最大液体容量                                                                                   |
|     state.units_liquid      |                                                                           游戏当前使用的速度单位（B，桶，或者说一立方米）                                                                           |
|    state.boiler_pressure    |                                                                                   车辆当前锅炉压力                                                                                   |
|  state.max_boiler_pressure  |                                                                                   车辆最大锅炉压力                                                                                   |
| state.units_boiler_pressure | 游戏当前使用的锅炉压力单位（[BAR](https://baike.baidu.com/item/%E5%B7%B4/10756114)或[PSI](https://baike.baidu.com/item/%E7%A3%85%E5%8A%9B%2F%E5%B9%B3%E6%96%B9%E8%8B%B1%E5%AF%B8/65002176)） |
|      state.temperature      |                                                                                 车辆当前气缸/引擎温度                                                                                  |
|    state.max_temperature    |                                                                         蒸汽机车是100（摄氏度），内燃机车是150（摄氏度）                                                                          |
|   state.units_temperature   |                                                                 游戏当前使用的温度单位（C、F或K，但此处开尔文是摄氏度直接加270，而非273.15）                                                                 |
|    state.brake_pressure     |                                                                   车辆当前刹车（我一直没弄明白brake_pressure什么意思）大小的百分比                                                                    |
|  state.max_brake_pressure   |                                                                                     100                                                                                      |
| state.units_brake_pressure  |                                                                                      %                                                                                       |
|      state.cargo_fill       |                                                                                 车辆当前物品容量百分比                                                                                  |
|    state.max_cargo_fill     |                                                                                     100                                                                                      |
|   state.units_cargo_fill    |                                                                                      %                                                                                       |

## 动画相关

### 动画变量
标记此元素绑定的动画变量来源，四选一即可，不写也行。作为输入时，如果写重复了，那会按照以下顺序读取从上到下的第一个。 </br>动画变量不对子元素生效。

| 字段名             | 数据类型   | 解释                                                                                       | 可否缺省 |
|-----------------|--------|------------------------------------------------------------------------------------------|------|
| readout         | String | 表示此组件与内置Readout绑定（参见[Animatrix一节](Animatrix.md)）。                                        | 是    |
| control         | String | 表示此组件与某个控制组绑定。                                                                           | 是    |
| setting         | String | 表示此组件与某个全局变量绑定，全局变量储存在`.minecraft/config/immersiverailroading_graphics.cfg`的`settings`内。 | 是    |
| texture_variant | String | 作为输入时，如果与车辆当前涂装变体名相等则为1，否则为0；作为输出时，当动画变量为1时切换车辆涂装变体为与自身名称一致的变体。                          | 是    |

>[!WARNING]
> 上文的透明度组件和全局缩放组件各自包含了一个`setting`。别重复了！

如果用的是`setting`，那么还可以额外在同元素内设置：

| 字段名             | 数据类型  | 解释                            | 可否缺省 |
|-----------------|-------|-------------------------------|------|
| setting_default | float | 对应全局变量缺失或未生成时会以此为默认值生成，不写默认为0 | 是    |

然后还有几个修饰符：

| 字段名         | 数据类型                         | 解释                                                                                                        | 可否缺省        |
|-------------|------------------------------|-----------------------------------------------------------------------------------------------------------|-------------|
| global      | boolean                      | 与Readout的`GLOBAL`相同                                                                                       | 是，默认为false  |
| invert      | boolean                      | 与Readout的`INVERT`相同                                                                                       | 是，默认为false  |
| translucent | boolean                      | 为true时会将透明度设置为与动画变量相同（0完全透明，1完全不透明，中间线性映射）                                                                | 是，默认为false  |
| toggle      | boolean                      | 与Readout的`TOGGLE`相同                                                                                       | 是，默认为false  |
| clamp       | 枚举值，仅可为`NONE`、`FLOOR`或`CEIL` | 若为`FLOOR`，则仅当动画变量大于0.95时执行为1的动画，否则执行为0的</br>若为`CEIL`，则仅当动画变量小于0.05时执行为0的动画，否则执行为1的<br/>**应用顺序早于`invert`** | 是，默认为`NONE` |

>[!WARNING]
> 上文的透明度组件包含了一个`translucent = true`。别重复了！

### 音效

基本定义就是控件音效定义。

|      关键字      |        类型        |            含义             |
|:-------------:|:----------------:|:-------------------------:|
|   `engage`    | ResourceLocation |         玩家按下控件时播放         |
|    `move`     | ResourceLocation |        玩家操控控件途中播放         |
| `movePercent` |      float       | 在播放move前，控件的动画变量需要至少改变多少？ |
|  `disengage`  | ResourceLocation |         玩家松开控件时播放         |

### 移动、缩放与旋转，还有变色

原理和Readout的差不多，都是声明动画变量为1时的变换参数，0表示不变换，中间值线性映射到各个状态。这三个可以共存。

此处的变换会应用到子级元素上。

```caml
  element:
    translate = 
      x = 10
      y = 20
      ......
```
| 字段名       | 数据类型 | 解释             | 可否缺省   |
|-----------|------|----------------|--------|
| translate | N/A  | 表示此元素有位移动画     | 是      |
| x         | int  | 此元素水平方向位移，单位像素 | 是，默认为0 |
| y         | int  | 此元素竖直方向位移，单位像素 | 是，默认为0 |

```caml
  element:
    rotate = 
      x = 10
      y = 20
      degrees = 90
      offset = -45
      ......
```
| 字段名     | 数据类型 | 解释                                       | 可否缺省   |
|---------|------|------------------------------------------|--------|
| rotate  | N/A  | 表示此元素有旋转动画，旋转中心点为元素原点。（善用Ctrl+F）         | 是      |
| x       | int  | 此元素旋转中心在水平方向的偏移量，单位像素                    | 是，默认为0 |
| y       | int  | 此元素旋转中心在竖直方向的偏移量，单位像素                    | 是，默认为0 |
| degrees | int  | 此元素动画变量为1时的旋转角度，逆时针为正，单位度                | 是，默认为0 |
| offset  | int  | 此元素的旋转角度偏移量（无论如何都会在最后额外旋转这个角度），逆时针为正，单位度 | 是，默认为0 |

```caml
  element:
    scale = 
      x = 1
      y = 2
      ......
```
| 字段名   | 数据类型 | 解释                          | 可否缺省   |
|-------|------|-----------------------------|--------|
| scale | N/A  | 表示此元素有缩放动画，缩放中心点为元素原点。      | 是      |
| x     | int  | 此元素在水平方向的缩放倍数，实际缩放量为此值*动画变量 | 是，默认为0 |
| y     | int  | 此元素在水平方向的缩放倍数，实际缩放量为此值*动画变量 | 是，默认为0 |

>[!WARNING]
> 上文的全局缩放组件包含了
> ```caml
> scale =
>   x = 4
>   y = 4
> ```。别重复了！

```caml
  element:
    color = 
      0 = "0x99d1c715"
      0.95 = "0x99d16c15"
      ......
```
| 字段名            | 数据类型                 | 解释                           | 可否缺省    |
|----------------|----------------------|------------------------------|---------|
| color          | N/A                  | 表示此元素有变色效果。                  | 是       |
| 接下来的数字，类型float | String（Hex颜色，格式ARGB） | 此元素动画变量大于本值且小于下一个值时混合使用的目标颜色 | 有什么意义吗？ |

混合原理参见[LearnOpenGL-CN](https://learnopengl-cn.github.io/04%20Advanced%20OpenGL/03%20Blending/#_3)，此处的参数为blend(SRC_ALPHA, ONE_MINUS_SRC_ALPHA)
